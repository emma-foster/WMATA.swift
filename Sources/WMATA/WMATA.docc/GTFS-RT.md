# GTFS-RT

Handling Protocol Buffer GTFS-RT data from the WMATA API.

## Overview

WMATA publishes GTFS-RT data in the form of [Protocol Buffers](https://developers.google.com/protocol-buffers), as opposed to Standard API data which is published in JSON. This can mean the data is sent to your application more effeciently. However, Protocol Buffers are more difficult to work with than JSON data.

WMATA.swift does not support GTFS Static data that is updated infrequently by WMATA. If you need static data, check out the [GTFS](https://github.com/emma-k-alexandra/GTFS) package.

## Swift Protobuf

WMATA.swift uses [Swift Protobuf](https://github.com/apple/swift-protobuf) to provide Swift types for GTFS-RT data. Swift Protobuf generates types from the [GTFS-RT Protocol Definition](https://github.com/google/transit/blob/master/gtfs-realtime/proto/gtfs-realtime.proto). This generated code is included in WMATA.swift, so you do not need to generate it yourself.

## GTFS-RT Feeds

GTFS-RT provides three types of real time data, called [Feed Entities](https://developers.google.com/transit/gtfs-realtime/guides/feed-entities). These feeds are Trip Updates, Service Alerts and Vehicle Positions. For WMATA, MetroRail and MetroBus provide separate feeds, for a total of six feeds.

### Trip Updates

The Trip Updates feed contains fluctuations in the [timetable specified by GTFS Static][gtfs-dataset-files]. You can get this feed via ``Rail/GTFS/TripUpdates`` or ``Bus/GTFS/TripUpdates``.

See: [GTFS-RT Trip Updates](https://developers.google.com/transit/gtfs-realtime/guides/trip-updates)

### Service Alerts

The Service Alerts feed contains updates on disruptions in the network like delays and cancellation of trips. You can get this feed via ``Rail/GTFS/Alerts`` or ``Bus/GTFS/Alerts``.

See [GTFS-RT Service Alerts](https://developers.google.com/transit/gtfs-realtime/guides/service-alerts)

### Vehicle Positions

The Vehicle Positions feed contains live GPS positions of buses or trains. You can get this feed via ``Rail/GTFS/VehiclePositions`` or ``Bus/GTFS/VehiclePositions``.

See [GTFS-RT Vehicle Positions](https://developers.google.com/transit/gtfs-realtime/guides/vehicle-positions)

## Example

Working with GTFS-RT types generated by Swift Protobuf can be awkward. Let's walk through getting the GPS coordinates of a vehicle in the MetroRail Vehicle Positions feed.

First, let's request vehicle positions from the WMATA API.
```swift
let vehiclePositions = Rail.GTFS.VehiclePositions(key: TEST_API_KEY)

let result = await vehiclePositions.request()
```

Let's unwrap the result.

```swift
switch result {
case let .success(feedMessage):
    print(feedMessage)
case let .failure(error):
    print(error)
}
```

Now, we have `feedMessage` which is a ``TransitRealtime_FeedMessage``. Feed Messages contain multiple ``TransitRealtime_FeedEntity`` in their ``TransitRealtime_FeedMessage/entity`` property. Let's grab the first vehicle position in this message.

```swift
let feedEntity = feedMessage.entity.first!

if feedEntity.hasVehicle {
    let vehiclePosition = feedEntity.vehicle
    print(vehiclePosition)
}
```

After checking if this message has an vehicle position set by the WMATA API via `hasPosition`, we were able to extract `vehiclePosition`, which is a ``TransitRealtime_VehiclePosition``. Note that ``TransitRealtime_FeedEntity/vehicle`` will always return a vehicle position instance, even if WMATA did not set this property. This is a quirk for Swift Protobuf and the GTFS-RT protocol definition. Properties on GTFS-RT types always have a default value. However, if you want to know if the property was explicitly set and has non-default data, you must check it's associated `has...` property.

Finally, let's get the latitude and longitude of the vehicle.

```swift
if vehiclePosition.hasPosition {
    let position = feedEntity.vehicle.position
    let latitude: Float
    let longitude: Float
    
    guard position.hasLatitude else {
        return
    }
    
    latitude = position.latitude
    
    guard position.hasLongitude else {
        return
    }
    
    longitude = position.longitude
    
    print("(\(latitude), \(longitude)") // (38.8764971, -77.0054798)
}
```

Now we have the GPS coordinates of the first train in the MetroRail GTFS-RT Vehicle Position feed.

### Complete Example

```swift
let vehiclePositions = Rail.GTFS.VehiclePositions(key: TEST_API_KEY)

let result = await vehiclePositions.request()

switch result {
case let .success(feedMessage):
    let feedEntity = feedMessage.entity.first!
    
    if feedEntity.hasVehicle {
        let vehiclePosition = feedEntity.vehicle
        
        if vehiclePosition.hasPosition {
            let position = feedEntity.vehicle.position
            let latitude: Float
            let longitude: Float
            
            guard position.hasLatitude else {
                return
            }
            
            latitude = position.latitude
            
            guard position.hasLongitude else {
                return
            }
            
            longitude = position.longitude
            
            print("(\(latitude), \(longitude)") // (38.8764971, -77.0054798)
        }
    }
case let .failure(error):
    print(error)
}
```

## Topics

### GTFS-RT Feed Messages

- ``TransitRealtime_FeedHeader``
- ``TransitRealtime_FeedMessage``

### GTFS-RT Feed Entities

- ``TransitRealtime_Alert``
- ``TransitRealtime_VehiclePosition``
- ``TransitRealtime_TripUpdate``
- ``TransitRealtime_FeedEntity``

### Other GTFS-RT Data
- ``TransitRealtime_Position``
- ``TransitRealtime_TimeRange``
- ``TransitRealtime_TranslatedString``
- ``TransitRealtime_TripDescriptor``
- ``TransitRealtime_EntitySelector``
- ``TransitRealtime_VehicleDescriptor``

[gtfs-dataset-files]: https://developers.google.com/transit/gtfs/reference#dataset_files
